// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  STAFF
  CLIENT
}

enum UserStatus {
  ENABLED
  DISABLED
}

enum ProjectStatus {
  PENDING
  AWAITING_APPROVAL
  IN_PROGRESS
  COMPLETED
}

enum ProjectEventType {
  CREATED
  START_REQUESTED
  APPROVED
  PROGRESS_UPDATE
  COMPLETED
}

enum DocumentCategory {
  REPORT
  CONTRACT
  DRAWING
  INVOICE
  ANALYTICS
  OTHER
}

enum ProcurementStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum ProcurementItemType {
  MATERIAL
  SERVICE
}

enum PurchaseOrderStatus {
  CREATED
  ORDERED
  PARTIALLY_DELIVERED
  DELIVERED
  CANCELLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  APPROVE
  REJECT
  SUBMIT
  UPLOAD
  DOWNLOAD
  ASSIGN
  COMPLETE
  LOGIN
  REMOVE
  REQUEST
}

enum AuditEntity {
  PROJECT
  PROCUREMENT
  PURCHASE_ORDER
  DOCUMENT
  USER
  INVOICE
  RECEIPT
}

enum ProjectCategory {
  CONSTRUCTION
  ENGINEERING
  PROCUREMENT
  CONSULTANCY
  MAINTENANCE
  GOVERNMENT
  RESEARCH
  TECH
}

enum ChatThreadType {
  MAIN        // Client + Assigned Staff + Admins
  STAFF_ONLY  // Assigned Staff + Admins
  CUSTOM      // Admin-created
}

enum InvoiceStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  PAID
  OVERDUE
}

enum TimesheetStatus {
  PENDING
  APPROVED
  REJECTED
}

model AuditLog {
  id        String   @id @default(uuid())

  action    AuditAction
  entity    AuditEntity
  entityId  String

  actorId  String
  actor    User @relation(fields: [actorId], references: [id])

  message   String?

  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([actorId])
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(CLIENT)
  status    UserStatus @default(ENABLED)
  authInvalidatedAt DateTime?
  createdAt DateTime @default(now())
  companyName String?
  department  String?
  address     String?
  phone       String?

  // Relations
  ownedProjects Project[] @relation("ClientProjects")
  createdProjects Project[] @relation("StaffCreatedProjects")
  staffProjects ProjectStaff[]
  documentsUploaded Document[]
  approvedProjects Project[] @relation("ApprovedProjects")
  projectsUpdated ProjectUpdate[]
  notifications Notification[]

  procurementRequests ProcurementRequest[] @relation("UserProcurements")
  approvedProcurements ProcurementRequest[] @relation("ApprovedProcurements")
  orders      PurchaseOrder[]

  clientInvoices  Invoice[] @relation("ClientInvoices")
  createdInvoices  Invoice[] @relation("CreatedInvoices")
  approvedInvoices Invoice[] @relation("ApprovedInvoices")

  staffTimesheets   TimesheetEntry[] @relation("StaffTimesheets")
  reviewedTimesheets TimesheetEntry[] @relation("ReviewedTimesheets")

  chats       ChatParticipant[]
  chatMessages  ChatMessage[]
  actions     AuditLog[]
  otpTokens   OtpToken[]
}

model CompanyProfile {
  id           String   @id @default("default")
  name         String
  department   String?
  address      String?
  email        String?
  phone        String?
  mapLabel     String?
  mapAddress   String?
  mapUrl       String?
  mapEmbedUrl  String?
  mapLat       Float?
  mapLng       Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model OtpToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  purpose   String
  otpHash   String
  expiresAt DateTime
  consumedAt DateTime?
  createdAt DateTime @default(now())

  @@index([userId, purpose])
  @@index([expiresAt])
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    ProjectCategory?
  status      ProjectStatus   @default(PENDING)
  budget      Float?

  // Client (Owner)
  clientId    String
  client      User     @relation("ClientProjects", fields: [clientId], references: [id])

  // Staff assigned
  staff       ProjectStaff[]

  // Documents
  documentGroup DocumentGroup[]

  approvedById String?
  approvedBy   User?         @relation("ApprovedProjects", fields: [approvedById], references: [id])
  createdById   String?
  createdBy    User?          @relation("StaffCreatedProjects", fields: [createdById], references: [id])

  createdAt   DateTime @default(now())
  eCD         DateTime? 
  updatedAt   DateTime @default(now())

  updates ProjectUpdate[]

  procurements ProcurementRequest[]

  invoices Invoice[]
  timesheets TimesheetEntry[]

  threads     ChatThread[]
}

model ProjectStaff {
  id        String   @id @default(uuid())
  projectId String
  staffId   String

  project   Project @relation(fields: [projectId], references: [id])
  staff     User    @relation(fields: [staffId], references: [id])

  assignedAt DateTime @default(now())

  @@unique([projectId, staffId])
}

model Document {
  id        String   @id @default(uuid())
  name      String
  fileUrl   String

  uploadedById String
  uploadedBy   User    @relation(fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())
  category DocumentCategory
  version   Int
  groupId   String
  group     DocumentGroup @relation(fields: [groupId], references: [id])
  @@unique([groupId, version])
}

model DocumentGroup {
  id        String   @id @default(uuid())
  name      String
  category  DocumentCategory

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  procurementRequestId String?
  procurementRequest   ProcurementRequest?  @relation(fields: [procurementRequestId], references: [id])

  purchaseOrderId String?
  purchaseOrder   PurchaseOrder?  @relation(fields: [purchaseOrderId], references: [id])

  documents Document[]

  createdAt DateTime @default(now())

  @@index([procurementRequestId])
  @@index([purchaseOrderId])
  @@index([projectId])
}

model ProjectUpdate {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])

  staffId   String
  staff     User     @relation(fields: [staffId], references: [id])
  eventType ProjectEventType

  note      String
  progress  Int      // 0 - 100

  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String   // PROJECT_APPROVAL, DOCUMENT_UPLOAD, etc
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ProcurementRequest {
  id          String   @id @default(uuid())
  title       String
  description String?
  status      ProcurementStatus @default(DRAFT)

  projectId   String
  project     Project @relation(fields: [projectId], references: [id])

  createdById String
  createdBy   User    @relation("UserProcurements", fields: [createdById], references: [id])

  approvedById String?
  approvedBy   User?  @relation("ApprovedProcurements", fields: [approvedById], references: [id])
  
  items    ProcurementItem[]
  documents   DocumentGroup[]
  cost      Float?

  purchaseOrder      PurchaseOrder?

  rejectionReason String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProcurementItem {
  id          String   @id @default(uuid())
  name        String
  quantity    Int
  unit        String   // e.g. kg, pcs, hours
  estimatedCost Float?

  type        ProcurementItemType

  requestId   String
  pRequest     ProcurementRequest @relation(fields: [requestId], references: [id])

  createdAt   DateTime @default(now())
}

model PurchaseOrder {
  id          String   @id @default(uuid())
  orderNumber String   @unique

  requestId   String @unique
  pRequest     ProcurementRequest @relation(fields: [requestId], references: [id])

  status      PurchaseOrderStatus @default(CREATED)

  orderedById String
  orderedBy   User @relation(fields: [orderedById], references: [id])

  orderedAt   DateTime?
  deliveredAt DateTime?

  notes       String?
  documents   DocumentGroup[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  status        InvoiceStatus @default(DRAFT)

  projectId     String
  project       Project       @relation(fields: [projectId], references: [id])

  clientId      String
  client        User          @relation("ClientInvoices", fields: [clientId], references: [id])

  createdById   String
  createdBy     User          @relation("CreatedInvoices", fields: [createdById], references: [id])

  approvedById  String?
  approvedBy    User?         @relation("ApprovedInvoices", fields: [approvedById], references: [id])

  issueDate     DateTime      @default(now())
  dueDate       DateTime

  subtotal      Float
  tax           Float
  total         Float

  notes           String?
  rejectionReason String?

  clientMarkedPaid   Boolean   @default(false)
  clientMarkedPaidAt DateTime?
  paymentConfirmedAt DateTime?
  paidAt             DateTime?

  fileUrl      String?
  receiptUrl   String?

  lineItems    InvoiceLineItem[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([projectId])
  @@index([clientId])
  @@index([status])
}

model InvoiceLineItem {
  id          String  @id @default(uuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
  description String
  quantity    Int
  rate        Float
  amount      Float
}

model TimesheetEntry {
  id        String   @id @default(uuid())
  projectId String
  staffId   String

  project   Project  @relation(fields: [projectId], references: [id])
  staff     User     @relation("StaffTimesheets", fields: [staffId], references: [id])

  entryDate DateTime
  hours     Float
  notes     String?

  status    TimesheetStatus @default(PENDING)
  submittedAt DateTime @default(now())

  reviewedById String?
  reviewedBy   User?    @relation("ReviewedTimesheets", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  rejectionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([staffId])
  @@index([status])
  @@index([entryDate])
}

model ChatThread {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])

  type      ChatThreadType
  name      String?

  participants ChatParticipant[]
  messages     ChatMessage[]

  createdAt DateTime @default(now())

  @@unique([projectId, type])
}

model ChatParticipant {
  id        String   @id @default(uuid())
  threadId  String
  userId    String

  thread    ChatThread @relation(fields: [threadId], references: [id])
  user      User       @relation(fields: [userId], references: [id])

  joinedAt  DateTime @default(now())
  leftAt    DateTime?

  @@unique([threadId, userId])
}

model ChatMessage {
  id        String   @id @default(uuid())
  threadId  String
  senderId  String

  content   String?
  type      String   // TEXT | FILE | IMAGE

  thread    ChatThread @relation(fields: [threadId], references: [id])
  sender    User       @relation(fields: [senderId], references: [id])

  attachments ChatAttachment[]
  reads       MessageRead[]

  createdAt DateTime @default(now())
}

model ChatAttachment {
  id        String   @id @default(uuid())
  messageId String
  fileUrl   String
  mimeType String
  isImage  Boolean

  message  ChatMessage @relation(fields: [messageId], references: [id])
}

model MessageRead {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())
  
  message   ChatMessage @relation(fields: [messageId], references: [id])

  @@unique([messageId, userId])
}
